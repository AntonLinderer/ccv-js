<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Track Learn Detect</title>
    <script type="text/javascript" src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script type="text/javascript" src="build/ccv.js"></script>
    <script type="text/javascript">
      $(() => {
        let renderRect = ({ x, y, width, height }) => {
          return $('<div class="rect">').css({
            position: 'absolute',
            left: x,
            top: y,
            width,
            height,
            border: '1px solid black',
            backgroundColor: 'rgba(0, 255, 0, 0.5)',
            pointerEvents: 'none'
          });
        }

        let stats = new Stats();
        stats.showPanel(0);
        $(stats.domElement).appendTo('body').css({ position: 'absolute', left: 0, bottom: 0 });

        let canvasContainer = $('#canvas-container');

        var clickBox;
        let canvas = $('#canvas')
          .on('click touchstart', (e) => {
            let rect = canvas.getBoundingClientRect();
            let x = canvas.width * (e.clientX - rect.left) / (rect.right - rect.left);
            let y = canvas.height * (e.clientY - rect.top) / (rect.bottom - rect.top);
            clickBox = {
              x: x - 10,
              y: y - 10,
              width: 20,
              height: 20
            };
            console.log('clicked', clickBox);
            $('.rect').remove();
            canvasContainer.append(renderRect(clickBox));
          })[0];


        let video = document.createElement('video');
        navigator.mediaDevices.getUserMedia({
          video:  {
            mandatory: {
              maxWidth: 160,
              maxHeight: 120
            }
          }
        }).then((stream) => {
          video.src = window.URL.createObjectURL(stream);
          video.onloadedmetadata = loop;
          video.play();
        }).catch((e) => {
          alert(e.toString() + '\n' + 'This demo requires a webcam');
        });

        let tracker = new Module.TLDTracker();

        let loop = () => {
          requestAnimationFrame(loop);
          if (video.readyState > 2) {
            stats.begin();


            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            let context = canvas.getContext('2d');
            context.drawImage(video, 0, 0);
            let imageData = context.getImageData(0, 0, canvas.width, canvas.height);

            if (clickBox) {
              $('.patch').remove();
              tracker.init(imageData, clickBox, Module.ccv_tld_default_params);
              clickBox = null;
            } else {
              tracker.track(imageData, (info, found, top) => {
                $('.rect').remove();
                canvasContainer
                  .append(top.map((comp) => {
                    return renderRect(comp.rect).css('opacity', comp.classification.confidence / 100);
                  }));
                if (info.track_success) {
                  canvasContainer
                    .append(renderRect(found.rect).css({
                      borderColor: 'red'
                    }));
                }
                if (info.perform_learn) {
                  imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                  let patch = $('<canvas class="patch">').prependTo('#tld-patches')[0];
                  patch.width = found.rect.width;
                  patch.height = found.rect.height;
                  patch.getContext('2d').putImageData(imageData, -found.rect.x, -found.rect.y, found.rect.x, found.rect.y, found.rect.width, found.rect.height);
                }
              });
            }
            stats.end();
          } else {
            console.log('Video not ready');
          }
        };
      });
    </script>
  </head>
  <body>
    <ul>
      <li>Need webcam permissions.</li>
      <li>Only works on latest chrome.</li>
      <li>Click to start tracking (needs a few frames to warm up).</li>
      <li>Click again to track something else.</li>
    </ul>

    <div id="canvas-container" style="position:relative">
      <canvas id="canvas"></canvas>
    </div>
    <div id="tld-patches" style="max-height: 200px; overflow-y: auto;"></div>
  </body>
</html>
